---
title: 'Final Assignment: Predicting Director Compensation'
author: "Jasper Ginn (s6100848)"
date: "April 8, 2019"
output:
  pdf_document: 
    number_sections: false
header-includes:
 \usepackage{float}
 \usepackage{setspace}
 \usepackage{xcolor}
 \definecolor{mypurple}{rgb}{146,76,239}
 \singlespacing
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.pos="H", fig.width = 7, fig.height = 4, echo = FALSE, 
                      fig.align="center", warning = FALSE, message = FALSE, eval=TRUE)
```

# Introduction

```{r}
rm(list=ls())
# Subset
library(dplyr)
d <- read.csv2("data/FinalData.csv") %>%
  # Select only independent directors
  filter(isED == 0) %>%
  # Select only these variables
  select(Recent_Comp_Thous, Sector, isM, Age) %>%
  # Remove NA
  filter(!is.na(Recent_Comp_Thous),
         !is.na(Age)) %>%
  # Log compensation
  mutate(compensation = log(Recent_Comp_Thous)) %>%
  # Remove these variables
  select(-Recent_Comp_Thous) %>%
  # Center data
  mutate(Age = Age - mean(Age),
         isM = isM - mean(isM)) %>%
  # Filter small sectors
  filter(!Sector %in% c("Money Center Banks", "Property & Casualty Insurance")) %>%
  # Filter sectors and add re-factor
  filter(Sector %in% c("Services", "Basic Materials", "Financial", "Healthcare", "Consumer Goods", "Technology")) %>%
  mutate(Sector = factor(as.character(Sector), 
                         levels = c("Services", "Basic Materials", "Financial", "Healthcare", "Consumer Goods", "Technology")))

# Outcome variable
library(ggplot2)
d %>%
  ggplot(., aes(x=compensation)) +
  geom_histogram(bins=50, color="black")

d %>%
  ggplot(aes(x=Age, y=compensation, color=as.factor(isM))) +
  geom_point() +
  geom_smooth(method="lm")
```

```{r}
# Load blm
library(blm)

# Set up blm
blm_setup()
```

```{r}
# Make the object
director_fit <- blm("compensation ~ .",
                data=d) %>%
  # Update samplers
  #set_sampler("b5", type="MH", lambda = 0.005) %>%
  #set_sampler("b6", type="MH", lambda = 0.05) %>%
  # Add prior
  #set_prior("b1", mu=2, sd=4) %>%
  # Update sampling settings
  set_sampling_options(chains = 2, iterations = 20000,
                       burn = 2000, thinning=3) %>%
  set_prior("b6", mu = 1.5, sd = 0.5) %>%
  set_prior("b1", mu = -1, sd=0.1)
  # Set priors
  # We are predicting on a log scale so approx ~ mu 0, sd log(1000)
  #set_initial_values(chain_1 = list("b" = c(1,1,1,1,1,1,1,1), sigma="0.1"),
  #                   chain_2 = list("b" = c(2,2,2,2,2,2,2,2), sigma="0.2"))
```

```{r}
# Draw samples from the posterior
director_fit <- director_fit %>%
  # Sample the posterior
  sample_posterior()
```

```{r}
# Add samples to the posterior distribution
director_fit <- director_fit %>%
  update_posterior(iterations = 15000)
```

```{r}
# Convergence diagnostics
director_fit <- director_fit %>%
  set_sampling_options(burn = 6000) 

director_fit %>%
  convergence_diagnostics()
```


```{r}
director_fit %>%
  evaluate_accepted_draws()
```

```{r}
# effective sample size
director_fit %>%
  evaluate_effective_sample_size()
```

```{r}
# History plot
plot(director_fit, "history")
```

```{r}
# Autocorrelation
plot(director_fit, "autocorrelation")
```

```{r}
summary(director_fit)
```

```{r}
director_ppc <- director_fit %>%
  evaluate_ppc()
director_ppc
```

```{r}
plot(predict(director_fit), resid(director_fit))
```

```{r}
director_fit %>%
  evaluate_model_fit()
```

```{r}
# R2
director_r2 <- director_fit %>%
  evaluate_R2()

# Plot
mean(director_r2$rsquared)
plot(director_r2)
```

```{r}
normal <- readRDS("data/ppc_normal_data.rds")
heter <- readRDS("data/ppc_heteronormal_data.rds")
corr <- readRDS("data/ppc_autocor_data.rds")

# Load ggplot
library(ggplot2)
library(gridExtra)

p1 <- ggplot(data.frame(x=normal[,2]), aes(x=x)) +
  geom_histogram(color="black") +
  scale_x_continuous(limits=c(0,1))
p2 <- ggplot(data.frame(x=normal[,3]), aes(x=x)) +
  geom_histogram(color="black")+
  scale_x_continuous(limits=c(0,1))
p3 <- ggplot(data.frame(x=heter[,2]), aes(x=x)) +
  geom_histogram(color="black")+
  scale_x_continuous(limits=c(-0.02,1))
p4 <- ggplot(data.frame(x=corr[,3]), aes(x=x)) +
  geom_histogram(color="black")+
  scale_x_continuous(limits=c(0,1))

grid.arrange(p1, p2, p3, p4)
```
