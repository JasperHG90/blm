---
title: 'Final Assignment: Predicting Alcohol Content in Wine using Bayesian Linear Regression'
author: "Jasper Ginn (s6100848)"
date: "April 8, 2019"
output:
  pdf_document: 
    number_sections: false
header-includes:
 \usepackage{float}
 \usepackage{setspace}
 \usepackage{xcolor}
 \definecolor{mypurple}{rgb}{146,76,239}
 \doublespacing
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.pos="H", fig.width = 7, fig.height = 4, echo = FALSE, 
                      fig.align="center", warning = FALSE, message = FALSE, eval=TRUE)
```

# Introduction

```{r}
rm(list=ls())
# Subset
library(dplyr)
d <- read.csv2("data/FinalData.csv") %>%
  filter(isED == 0) %>%
  select(Recent_Comp_Thous, Sector, isM, isED, Age) %>%
  # Remove NA
  filter(!is.na(Recent_Comp_Thous),
         !is.na(Age)) %>%
  mutate(compensation = log10(Recent_Comp_Thous)) %>%
  select(-Recent_Comp_Thous, -isED) %>%
  mutate(Age = Age - mean(Age),
         isM = isM - mean(isM)) %>%
  filter(Sector %in% c("Services", "Technology", "Financial", "Consumer Goods")) %>%
  mutate(Sector = factor(as.character(Sector), 
                         levels = c("Technology", "Financial", "Services", "Consumer Goods")))

# Outcome variable
library(ggplot2)
d %>%
  ggplot(., aes(x=compensation)) +
  geom_histogram(bins=50, color="black")

d %>%
  ggplot(aes(x=Age, y=log10(Recent_Comp_Thous), color=as.factor(isM))) +
  geom_point() +
  geom_smooth(method="lm")
```

```{r}
# Load blm
library(blm)

# Set up blm
blm_setup()

```

```{r}
set.seed(1629)
# Make the object
director_fit <- blm("compensation ~ Age + isM * Sector",
                data=d) %>%
  # Update samplers
  set_sampler("b1", type="MH", lambda = 0.005) %>%
  set_sampler("b2", type="MH", lambda = 0.05) %>%
  # Update sampling settings
  set_sampling_options(chains = 2, iterations = 40000,
                       burn = 2000, thinning=3) %>%
  # Set initial values
  set_initial_values(chain_1 = list("b" = c(runif(9, -10, 10)), "sigma" = 10),
                     chain_2 = list("b" = c(runif(9, -10, 10)), "sigma" = 5)) %>%
  # Sample the posterior
  sample_posterior()
```

```{r}
# Add samples to the posterior distribution
director_fit <- director_fit %>%
  update_posterior(iterations = 25000)
```

```{r}
# Convergence diagnostics
director_fit <- director_fit %>%
  set_sampling_options(burn = 10000) 

director_fit %>%
  convergence_diagnostics()
```


```{r}
director_fit %>%
  evaluate_accepted_draws()
```

```{r}
# effective sample size
director_fit %>%
  evaluate_effective_sample_size()
```

```{r}
# History plot
plot(director_fit, "history")
```

```{r}
# Autocorrelation
plot(director_fit, "autocorrelation")
```

```{r}
summary(director_fit)
```

```{r}
director_ppc <- director_fit %>%
  evaluate_ppc()
director_ppc
```

```{r}
pd <- apply(get_posterior_samples(director_fit), 2, mean)
pred <- director_fit$input$X %*% pd[-10]
res <- d$compensation - pred
plot(pred, res)
```

```{r}
director_fit %>%
  evaluate_model_fit()
```

```{r}
normal <- readRDS("data/ppc_normal_data.rds")
heter <- readRDS("data/ppc_heteronormal_data.rds")
corr <- readRDS("data/ppc_autocor_data.rds")

# Load ggplot
library(ggplot2)
library(gridExtra)

p1 <- ggplot(data.frame(x=normal[,2]), aes(x=x)) +
  geom_histogram(color="black") +
  scale_x_continuous(limits=c(0,1))
p2 <- ggplot(data.frame(x=normal[,3]), aes(x=x)) +
  geom_histogram(color="black")+
  scale_x_continuous(limits=c(0,1))
p3 <- ggplot(data.frame(x=heter[,2]), aes(x=x)) +
  geom_histogram(color="black")+
  scale_x_continuous(limits=c(-0.02,1))
p4 <- ggplot(data.frame(x=corr[,3]), aes(x=x)) +
  geom_histogram(color="black")+
  scale_x_continuous(limits=c(0,1))

grid.arrange(p1, p2, p3, p4)
```
